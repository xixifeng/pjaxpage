/*!
 * pjaxPage JavaScript Library v1.0
 * https://gitee.com/xixifeng.com/pjaxpage
 *
 * Author: xixifeng (fastquery@126.com)  
 * 
 * Copyright JS Foundation and other contributors
 * Released under the MIT license
 *
 * Date: 2017-05-18
 */
(function($){$.extend({tpl:function(template,data){return template.replace(/\{([\w\.]*)\}/g,function(str,key){var keys=key.split("."),v=data[keys.shift()];for(var i=0,l=keys.length;i<l;i++){v=v[keys[i]]}return(typeof v!=="undefined"&&v!==null)?v:""})},pjaxPage:function(options){var successFnStr="",dataStr="";var defaults={ajax:{},size:15,pageKeyName:"page",sizeKeyName:"size",currentPage:1,dataListBox:$("#dataListBox"),pageCodeBox:$("#pageCodeBox"),pageInfoTpl:"<p>共{totalElements}条记录,总页数:{totalPages}</p>",buildTplSource:function(data,textStatus,jqXHR){return{totalElements:data[this.pageDataKeyName].totalElements,currentPage:data[this.pageDataKeyName].number,totalPages:data[this.pageDataKeyName].totalPages}},pageModel:{name:"numberModel"},pageDataKeyName:"pageData",createDataHtml:function(data,textStatus,jqXHR){return""},notFoundTip:"Not Found Data!",pageCodeItem:"a[tabindex]",eventName:"click",dataCache:true,clear:function(){this.dataListBox.removeData();return this},writeListBefore:function(){},writeListAfter:function(data,textStatus,jqXHR){},getReqParam:function(){var params={page:this.currentPage,size:this.size};return $.param(params)},pjaxId:"xixifeng_pjax",enabledPjax:true,pageHrefPre:window.location.href.replace(window.location.search,""),writeData:function(){var dataHtml=this.createDataHtml.call(this,this.data,this.textStatus,this.jqXHR);var pageModelName=this.pageModel.name;var modelMethod=$[pageModelName];modelMethod.call(this);if(dataHtml==""||dataHtml==null){dataHtml=this.notFoundTip}this.dataListBox.html(dataHtml).css("opacity",1);var cacheData=this.dataListBox.data("pageCode"+this.currentPage);if((cacheData==undefined||cacheData=="")&&this.dataCache){this.dataListBox.data("pageCode"+this.currentPage,this.data)}if(this.enabledPjax){this.pageCodeBox.find(this.pageCodeItem).each(function(){$(this).attr("href",$(this).attr("source"))})}this.writeListAfter.call(this,this.data,this.textStatus,this.jqXHR)},initPage:function(){if(countInitPage!=undefined){++countInitPage}var contextObj=this;this.dataListBox.css("opacity",0.5);this.writeListBefore.call(this);var dt=contextObj.getReqParam.call(contextObj);var ajaxSettings=this.ajax;if(successFnStr===""){if(!ajaxSettings.success){successFnStr="N"}else{successFnStr=ajaxSettings.success+""}}if(dataStr===""){if(!ajaxSettings.data){dataStr="N"}else{if($.type(ajaxSettings.data)==="string"){dataStr=ajaxSettings.data+""}else{dataStr=$.param(ajaxSettings.data)+""}}}ajaxSettings.data=$.type(dt)==="string"?dt:$.param(dt);if(dataStr!=="N"){ajaxSettings.data=ajaxSettings.data+"&"+dataStr}ajaxSettings.data=ajaxSettings.data.replace("page=",this.pageKeyName+"=").replace("size=",this.sizeKeyName+"=");ajaxSettings.success=function(data,textStatus,jqXHR){contextObj.data=data;contextObj.textStatus=textStatus;contextObj.jqXHR=jqXHR;contextObj.writeData.call(contextObj);if(successFnStr!=="N"){eval("("+successFnStr+")(contextObj.data,contextObj.textStatus,contextObj.jqXHR);")}};$.ajax(ajaxSettings)},triggerEvent:function(ts,evt){if(startReqData!=undefined){opts.getReqParam=startReqData}var currentPage=ts.attr("tabindex");this.currentPage=currentPage;var cacheData=this.dataListBox.data("pageCode"+currentPage);if(cacheData==""||cacheData==undefined){this.initPage.call(this)}else{this.data=this.dataListBox.data("pageCode"+currentPage);this.writeData.call(this)}if(this.enabledPjax&&supportPushState){evt.preventDefault();var reqd=ts.attr("href");history.pushState({reqParams:this.getReqParam(),pageIndex:this.currentPage},document.title,reqd)}},pageIndex:function(indexNum,currentPage,totalpage){var startpage=currentPage-((indexNum%2==0)?(indexNum/2-1):parseInt(indexNum/2));var endpage=currentPage+parseInt(indexNum/2);if(startpage<1){startpage=1;if(totalpage>=indexNum){endpage=indexNum}else{endpage=totalpage}}if(endpage>totalpage){endpage=totalpage;if((endpage-indexNum)>0){startpage=endpage-indexNum+1}else{startpage=1}}return{startpage:startpage,endpage:endpage}},queryParam:function(href,name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)","i");var r=href.match(reg);if(r!=null){return unescape(r[2])}return""}};var opts=$.extend(defaults,options);var listenEvent=function(evt){opts.triggerEvent.call(opts,$(this),evt)};opts.pageCodeBox.off(opts.eventName).on(opts.eventName,opts.pageCodeItem,listenEvent);var supportPushState=history.pushState;if(opts.enabledPjax&&supportPushState){var startReqData=opts.getReqParam;var home=opts.currentPage;var countInitPage=0;$(window).off("popstate").on("popstate",function(){if(countInitPage>1){var reqParams;var pageIndex;if(history.state!=null){reqParams=history.state.reqParams;pageIndex=history.state.pageIndex;opts.currentPage=pageIndex;opts.getReqParam=function(){return reqParams}}else{opts.currentPage=home;opts.getReqParam=startReqData}var cacheData=opts.dataListBox.data("pageCode"+pageIndex);if(!cacheData||cacheData==""){opts.initPage.call(opts)}else{if(!pageIndex){pageIndex=home}opts.data=opts.dataListBox.data("pageCode"+pageIndex);opts.writeData.call(opts)}if(pageIndex==undefined){}}})}var hrefPage=opts.queryParam(window.location.search.substr(1),"page");if($.isNumeric(hrefPage)){opts.currentPage=parseInt(hrefPage)}opts.initPage.call(opts);return opts}})})(jQuery);